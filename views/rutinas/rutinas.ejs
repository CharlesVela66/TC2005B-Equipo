<%- include('../includes/head.ejs'); %>
<% if (mensaje != '') { %>
    <div class="notification is-info is-light">
        <%= mensaje %>
    </div>
<% } %>

<% if (rol == "Cliente") {%>

<h1 class = "title is-1 has-text-white-ter">Rutinas Favoritas</h1>
<% if (rutinasFavs.length > 0) { %>
    <form action="/rutinas/eliminar_favs" method="POST" autocomplete="off">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" >
        <input type="hidden" name="id_rutina_fav" id="id_rutina_fav" value="">
    <div class="columns">
        <% let columns = 0; %>
        <% for (let rutinaFav of rutinasFavs) { %>
            <% if (columns % 4 == 0) { %>
    </div>
    <div class="columns">
            <% } %>
            <% columns++; %>
            <div class="column is-3">
                <div class="card" data-id="<%= rutinaFav.id_rutina %>">
                    <div class="card-image">
                        <div class="star">
                            <a onclick="delPopup('<%= rutinaFav.id_rutina %>')"> 
                                <i class="fas fa-star"></i>
                            </a>
                        </div>
                        <figure class="image is-4by3">
                            <a href="/rutinas/<%= rutinaFav.id_rutina %>"><img src="/uploads/<%= rutinaFav.URL_Image %>" alt="Placeholder image"></a>

                        </figure>
                    </div>
                    <div class="card-content">
                        <div class="media">
                            <div class="media-left">
                                <figure class="image is-48x48">
                                    <img src="https://cdn-icons-png.flaticon.com/512/1518/1518886.png" alt="Placeholder image">
                                </figure>
                            </div>
                            <div class="media-content">
                                <p class="title is-4 has-text-white-ter"><%= rutinaFav.nombre %></p>
                                <p class="subtitle is-6 has-text-white-ter"><%= rutinaFav.tiporutina %></p>
                            </div>
                        </div>
                    
                    </div>
                </div>
            </div>
        <% } %>
    </div>
    <div class="popup" id="del">
        <h2 class="title is-4 has-text-white-ter">¿Quieres eliminar esta rutina de Favoritos?</h2>
        <button class="button is-success" type = "submit">Sí</button>
        <button class="button is-danger" type="button" onclick="closeDelPopup()">No</button>
    </div>
    </form>
<% } %>

<h1 class = "title is-1 has-text-white-ter"> Más Rutinas</h1>
<div class="columns">
    <columns class="column is-2">
        <h2 class="has-text-white-ter is-1">Tipo De Rutina</h2>
            <div class="is-small is-rounded is-info select-customizado" id="tipo">
                <select id="tipoSelect">
                    <option selected = "true" disabled="disabled" value="%">Elige una opción</option>
                    <option value="Hipertrofia">Hipertrofia</option>
                    <option value="Mixto">Mixto</option>
                    <option value="Fuerza">Fuerza</option>
                </select>
            </div>
    </columns> 
    <columns class="column is-2">
        <h2 class="has-text-white-ter is-1">Frecuencia</h2>
            <div class="is-small is-rounded is-info select-customizado" id="frecuencia">
                <select id="frecuenciaSelect">
                    <option selected = "true" disabled="disabled" value="%">Elige una opción</option>
                    <% for (let i = 1; i <= 7; i+=1){ %>
                        <option value="<%= i %>">
                            <%= i %>
                        </option>
                    <% } %>
                </select>
            </div>
    </columns>  
    <columns class="column is-2">
        <h2 class="has-text-white-ter is-4">Nivel</h2>
            <div class="is-small is-rounded is-info select-customizado" id="nivel">
                <select id="nivelSelect">
                    <option selected = "true" disabled="disabled" value="%">Elige una opción</option>
                    <option value="1">Pricipiante</option>
                    <option value="2">Mixto</option>
                    <option value="3">Fuerza</option>
                </select>
            </div>
    </columns>
    <columns class="column is-2">
        <button class="button is-primary is-small" id="buscarBtn" style="margin-top: 15px; ;">Buscar</button>
    </columns>      
</div>
    
<% if (rutinas.length > 0) { %>
    <form action="/rutinas/agregar_favs" method="POST" autocomplete="off">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" >
        <input type="hidden" name="id_rutina" id="id_rutina" value="">
    <div class="container" id="rutinas">
        <div class="columns" >
            <% let columns = 0; %>
            <% for (let rutina of rutinas) { %>
                <% if (columns % 4 == 0) { %>
        </div>
        <div class="columns">
                <% } %>
                <% columns++; %>
                <div class="column is-3">
                    <div class="card" data-id="<%= rutina.id_rutina %>">
                        <div class="card-image">
                            <div class="star">
                                <a onclick="addPopup('<%= rutina.id_rutina %>')"> 
                                    <i class="far fa-star"></i>
                                </a>
                            </div>
                            <figure class="image is-4by3">
                                <a href="/rutinas/<%= rutina.id_rutina %>"><img src="/uploads/<%= rutina.URL_Image %>" alt="Placeholder image"></a>
                            </figure>
                        </div>
                        <div class="card-content">
                            <div class="media">
                                <div class="media-left">
                                    <figure class="image is-48x48">
                                        <img src="https://cdn-icons-png.flaticon.com/512/1518/1518886.png" alt="Placeholder image">
                                    </figure>
                                </div>
                                <div class="media-content">
                                    <p class="title is-4 has-text-white-ter"><%= rutina.nombre %></p>
                                    <p class="subtitle is-6 has-text-white-ter"><%= rutina.tiporutina %></p>
                                </div>
                            </div>
                        
                        </div>
                    </div>
                </div>
            <% } %>
        </div>
    </div>
    <div class="popup" id="popup">
        <h2 class="title is-4 has-text-white-ter">¿Quieres guardar esta rutina en Favoritos?</h2>
        <button class="button is-success" type = "submit">Sí</button>
        <button class="button is-danger" type="button" onclick="closeAddPopup()">No</button>
    </div>
    </form>
<% } else { %>
    <h1>No hay rutinas registradas</h1>
<% } %>   

<script>
    let popup = document.getElementById("popup");

    function addPopup(id){
        popup.classList.add("open-popup");
        document.getElementById("id_rutina").value = id;
    }

    function closeAddPopup(){
        popup.classList.remove("open-popup")
    }

    function delPopup(id){
        del.classList.add("open-popup");
        document.getElementById("id_rutina_fav").value = id;
    }
    function closeDelPopup(){
        del.classList.remove("open-popup");
    }

    const rutinasStr = "<%- escape(JSON.stringify(rutinas)) %>";
    const rutinas = JSON.parse(unescape(rutinasStr));

    // Seleccionamos el elemento de nuestro filtro
    const selectElementTipo = document.getElementById('tipo');
    const selectElementFrec = document.getElementById('frecuencia');
    const selectElementNivel = document.getElementById('nivel');
    const buscarBtn = document.getElementById('buscarBtn');

    // Le agregamos un evento al filtro, si cambia de valor...
    buscarBtn.addEventListener('click', (event) => {
        // Adquirimos el valor del evento
        
        let selectedTipo = document.getElementById('tipoSelect').value;
        let sFrec = document.getElementById('frecuenciaSelect').value;
        let sNivel = document.getElementById('nivelSelect').value;

        // Obtenemos las dietas que cumplan con el criterio mandandole una petición asíncrona
        fetch('/rutinas/buscar/' + selectedTipo + '?frecuencia=' + sFrec + '&nivel=' + sNivel, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(result => {
            return result.json();
        })
        .then(data => {
         // Se llama el metodo de displayRutina para mostrar las dietas que cumplen con la condicion al usuario
            displayRutina(data.rutinas);
        })
        .catch(err => {
            console.log(err);
        });
    });
    function displayRutina(rutinas){
        let containerRutina = document.getElementById('rutinas');
        containerRutina.innerHTML = '';
        
        let newHTML = '';
        let counter = 0;
        console.log(rutinas);
        for (let rutina of rutinas) {
            if (counter % 4 == 0) {
                if (counter != 0) {
                    newHTML += '</div>';
                }
                newHTML += '<div class="columns">';
            }
            counter++;

            newHTML += `
            <div class="column is-3">
                <div class="card" data-id="${rutina.id_rutina}">
                    <div class="card-image">
                        <div class="star">
                            <a onclick="addPopup( ${rutina.id_rutina})"> 
                                <i class="far fa-star"></i>
                            </a>
                        </div>
                        <figure class="image is-4by3">
                            <a href="/rutinas/${rutina.id_rutina}"><img src="/uploads/${rutina.URL_Image}" alt="Placeholder image"></a>
                        </figure>
                    </div>
                    <div class="card-content">
                        <div class="media">
                            <div class="media-left">
                                <figure class="image is-48x48">
                                    <img src="https://cdn-icons-png.flaticon.com/512/1518/1518886.png" alt="Placeholder image">
                                </figure>
                            </div>
                            <div class="media-content">
                                <p class="title is-4 has-text-white-ter">${rutina.nombre}</p>
                                <p class="subtitle is-6 has-text-white-ter">${rutina.tiporutina}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }

        if (counter % 4 != 0) {
            newHTML += '</div>';
        }

        containerRutina.innerHTML = newHTML;

    }

</script>
<% } else if (rol == "Administrador") { %>
    <h1 class = "title is-1 has-text-white-ter"> Rutinas</h1>
<% if (rutinas.length > 0) { %>
    <div class="columns">
        <% let columns = 0; %>
        <% for (let rutina of rutinas) { %>
            <% if (columns % 4 == 0) { %>
    </div>
    <div class="columns">
            <% } %>
            <% columns++; %>
            <div class="column is-3">
                <div class="card">
                    <div class="card-image">
                        <figure class="image is-4by3">
                            <a href="/rutinas/<%= rutina.id_rutina %>"><img src="/uploads/<%= rutina.URL_Image %>" 
                                alt="Hola"></a>
                        </figure>
                    </div>
                    <div class="card-content">
                        <div class="media">
                            <div class="media-left">
                                <figure class="image is-48x48">
                                    <img src="https://cdn-icons-png.flaticon.com/512/1518/1518886.png" alt="Placeholder image">
                                </figure>
                            </div>
                            <div class="media-content">
                                <p class="title is-4 has-text-white-ter"><%= rutina.nombre %></p>
                                <p class="subtitle is-6 has-text-white-ter"><%= rutina.tiporutina %></p>
                            </div>
                        </div>
                    
                    </div>
                </div>
            </div>
        <% } %>
    </div>
<% } else { %>
    <h1>No hay rutinas registradas</h1>
<% } %>   
<% } %>
<%- include('../includes/foot.ejs'); %>